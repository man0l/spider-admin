{% extends '::base.html.twig' %}

{% block body -%}
<div class="row">   
    <div class="col-xs-12 col-md-12">
        
        <h1>Amazon Items</h1>
 
        <div class="col-xs-4 col-md-1">
            {{ block('items_per_page') }}
        </div>
    </div>
   
</div>
<div class="row">
           
  <div class="col-xs-12 col-md-12">        
     
      {{ block('pagination') }}       
    
    <div class="panel panel-default">
        <div class="panel-heading">Total Items: {{ pagination.getTotalItemCount }}</div>
        <form id="container_checkbox" action="" method="POST">
        <table class="table">
            <thead>
                <tr>
                    <th><input name="check_all" id="check_all" type="checkbox" value="1"></th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Images</th>
                    <th>UPC</th>
                    <th>MPN/EAN</th>
                    <th>{{ knp_pagination_sortable(pagination, 'Sold', 'sold') }}</th>                    
                    <th>{{ knp_pagination_sortable(pagination, 'Profit', 'profit') }}</th>
                    <th>{{ knp_pagination_sortable(pagination, 'Reviews', 'reviewsNum') }}</th>
                    <th>{{ knp_pagination_sortable(pagination, 'Review score', 'reviews') }}</th>
                    <th>Asin</th>
                    <th>{{ knp_pagination_sortable(pagination, 'Created At', 'created_at') }}</th>
                  
                </tr>
            </thead>
            <tbody>
            {% for entity in pagination %}
                <tr {% if loop.index is odd %}class="odd"{% endif %}>
                    {# <td><a href="{{ path('admin_item_show', { 'id': entity.id }) }}">{{ entity.id }}</a></td> #}
                    <td>
                        <input name="check[]" id="check_{{ entity.id }}" class="checkbox_check {% if entity.asin == "" %}disabled{% endif %}" type="checkbox" value="{{ entity.id }}" {% if entity.asin == "" %}title="Please choose main ASIN first"{% endif %}>
                    </td>
                    <td>{{ entity.title }}</td>
                    <td> {{ entity.shortDesc | raw | striptags | truncate(200) }}</td>
                    <td> {# <a href="{{ path('amazon_gallery', with: { 'id': entity.id } ) }}">open gallery</a> #}
                        <a href="javascript:;" data-images="{{ entity.images_list }}" data-id="{{ entity.id }}"  class="bootstrap_modal_images">show images</a>
                    </td>
                    <td>{{ entity.upc }}</td>
                    <td>{% if entity.mpn %}MPN: {{ entity.mpn }} {% endif %} <br />                        
                        {% if entity.ean %}EAN: {{ entity.ean }} {% endif %}
                    </td>
                    
                    <td>${{ entity.sold | default(0) }}</td>

                    <td>${{ entity.profit | default(0) }}</td>                    
                    <td>{{ entity.reviewsNum | default(0) }}</td>                    
                    <td>{{ entity.reviews | default(0) }}</td>
                    
                    {# <td>{{ entity.category }}</td> #}
                    <td>{{ entity.asin }}</td>
                    <td>{% if entity.created_at %}{{ entity.created_at|date('Y-m-d H:i:s') }}{% endif %}</td>
                    
                </tr>
            {% endfor %}
            </tbody>
        </table>
        </form>
    </div>
        
  </div>
</div>
<div class="row">
    <div class="col-xs-12 col-md-12">
        <div class="dropdown col-xs-6 col-md-2 pull-left" >
            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                Action for selected items
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
               <li><a href="javascript:;" id="update_amazon"><span class="glyphicon glyphicon-bitcoin"></span> Update Amazon Price &amp; Info</a></li>
               <li><a href="javascript:;"><span class="glyphicon glyphicon-export"></span> Export in FileExchange</a></li>
               <li><a href="javascript:;"><span class="glyphicon glyphicon-export"></span> Export in Bonanza</a></li>
               <li><a href="javascript:;" id="add_tags_link"><span class="glyphicon glyphicon-tags"></span> Add tags</a></li>

           </ul>
        </div>
        <div class="add_tags col-xs-5 col-md-5 hide">
            <form class="form-inline">
               <div class="form-group">
                     <input type="text" name="add_tags_input" placeholder="add tags here" class="form-control" />                    
                </div>
                <button class="btn btn-info">save</button>
            </form>
        </div>
    </div>
</div>
 
    <div class="row">
        {{ block('pagination') }}
    </div>

        <!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                 <h4 class="modal-title"></h4>

            </div>
            <div class="modal-body"><div class="te"></div></div>
            <div class="modal-footer">
                
                <div class="row">
                    <div class="col-lg-4 col-sm-6 col-xs-8">
                        <form>
                            <div id="queue"></div>
                            <input id="file_upload" name="file_upload" type="file" multiple="true">
                            
                        </form>
                    </div>
                </div>
                <input type="hidden" value="" name="item_id" id="itemIDmodal">
                <button type="button" class="btn btn-info" id="save_images_item">Save Images</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                 
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
        
{% endblock %}
    
    
{% block javascripts %} 
    <script type="text/javascript">
        
        var imagePathFull = "{{ asset("images/full/") }}";
        var imagePathThumb = "{{ asset("images/thumbs/small/") }}";
        var saveImagesUrl = "{{ path('save_images') }}";
        
        $(document).ready(function(){
            

            
            
           
            $("#reset_form").click(function() {
                $('#filter_form')[0].reset();
                $("#filter_form input[type=checkbox]").attr('checked', false);
                return false;
            });
            
          
            
            $("select[name^=show_items]").change(function() {
                $("#items_per_page").submit();
            });
            
            
            $("#check_all").change(function() {
                $(".checkbox_check").prop('checked', this.checked);
            });
            
            // drop down menu items
           
            
            $("#update_amazon").click(function() {
                
               $.ajax({
                   url: "{{ path('update_amazon') }}",
                   data: $("#container_checkbox").serialize(),
                   method: "POST",
                   success: function(data) {
                         $(".dropdown").find('.glyphicon-refresh').remove();                                        
                         $(".dropdown").append($("<span>").attr('class', 'glyphicon glyphicon-ok'));

                   },
                    beforeSend: function() {
                         $(".dropdown").find('.glyphicon-ok').remove();
                         var $icon = $("<span>").addClass('glyphicon glyphicon-refresh glyphicon-refresh-animate');                                        
                         $(".dropdown").append($icon);                                        
                   }
                    
               });
            });
            
            
            
            $(".bootstrap_modal_images").click(function() {
                
                var icon = $("#save_images_item span");
                if(icon)
                {
                    $(icon).remove();                    
                }
                
                var images = $(this).data('images').split(",");
                var itemID = $(this).data('id');
                $("#itemIDmodal").val(itemID);
                
                var row = $("<div>").addClass("row").addClass('grid');
                
                if (images.length > 0)
                {
                    $modalBody = $("#myModal").find(".modal-body");
                    $modalBody.empty();                    
                    $modalBody.append(row);
                  
                    for ( img in images)
                    {
                        
                         addImages(row, images[img], imagePathThumb);
                         $modalBody.append(row);
                    }
                    
                    row.sortable( {
                        forceHelperSize: true,
                        placeholder: 'placeholder col-lg-3',
                        tolerance: 'pointer',
                        revert: 'invalid',
                    } );
                }
                
                
                
                 $("#myModal").modal('show');
               
                
                
            });
            
            
            $("#save_images_item").click(function() {
                
                // preloader 
                var $icon = $("<span>").addClass('glyphicon glyphicon-refresh glyphicon-refresh-animate');                                        
                $("#save_images_item").append($icon);                                        
                         
                // get all images in the same order
                $modalBody = $("#myModal").find(".modal-body");
                var images = $modalBody.find('.row img');
               
             
                var postData = "";
                var imgs = [];
                
                images.each(function(i, image) {
                    
                    postData += "order[]="+$(image).data('image')+"&";
                    imgs.push($(image).data('image'));
                });
                
                itemID =  $("#itemIDmodal").val();
                postData += "item_id=" + itemID;
                
                
                $.post(saveImagesUrl, postData, function() {
                     $("#myModal").modal('toggle');
                     
                     var row =  $("#container_checkbox a[data-id="+itemID+"]");                     
                     row.data('images', imgs.join(","));
             
                });
                
            });
        
        });
        

        // global namespace
        var addImages = function(appendToObject, image, imagePathThumb)
        {
            var imContainer = $("<div>").attr('class', "col-lg-3 col-sm-3 col-xs-4 tile");
            var closeContainer = $("<div>").attr('class', 'image-border');
            var close = $("<button>").text('x').attr('class',"close");
            var clearFix = $("<div>").addClass("clearfix");
            closeContainer.append(close);
            closeContainer.append(clearFix);
            var im = $("<img>").attr('src', imagePathThumb + image ).attr("class", 'thumbnail img-responsive').data('image', image);
            closeContainer.append(im);
            imContainer.append(closeContainer);
            appendToObject.append(imContainer);
        }
        
        
        $(function() {
            $('#file_upload').uploadifive({
                    'auto'             : true,
                     //'checkScript'      : 'check-exists.php',
                    'formData'         : {
                                            'timestamp' : '{{ timestamp }}',
                                            'token'     : '{{ hash }}'
                                         },
                    'queueID'          : 'queue',
                    'uploadScript'     : '{{ path('upload_image_amazon') }}',
                    'onUploadComplete' : function(file, data) { 
                                             
                                               addImages($(".modal-body").find('.row'), data, imagePathThumb);
                                               
                                         }
            });
        });
      
         

    </script>
{% endblock %}

{% block pagination %}
    
    <div class="navigation">
            {{ knp_pagination_render(pagination) }}
    </div>
{% endblock %}

{% block items_per_page %}
         <form class="form-inline pull-right" id="items_per_page" role="form" method="get" action="{{ path('admin_item',  app.request.query.all ) }}">
             <div class="form-group">
                <select name="show_items" class="form-control">
                    <option {% if app.request.query.get('show_items') == '20' %}{% endif %}>20</option>
                    <option {% if app.request.query.get('show_items') == '50' %}{% endif %}>50</option>
                    <option {% if app.request.query.get('show_items') == '100' %}{% endif %}>100</option>
                    <option {% if app.request.query.get('show_items') == '500' %}{% endif %}>500</option>
                </select>
             </div>
         </form>
{% endblock %}
